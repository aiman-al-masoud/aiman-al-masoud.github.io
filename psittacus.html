<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psittacus</title>
    
    <style>body{
    background: whitesmoke;
    font-family: sans-serif;
}

.tool_tip{
    color: red;
    visibility: hidden;
    display: none;
}

.word:hover + .tool_tip{
    display: inline;
    visibility: visible;
}

.hidden{
    visibility: hidden;
    display: none;
}

.displayed{
    visibility: visible;
    display: block;
}

.navbar, .footer{
    margin: 1vw; 
    border: double black 0.5vw; 
    background: green;
    border-radius: 6vw;
    color: black;
    padding: 1vw; 
}


.navbar{
    float: top; 
    margin-bottom: 5vh; 
}


.footer{
    float: bottom; 
    margin-top: 50vh; 
    margin-bottom: 0;
    text-align: center;
}


.textbox{
    width: 50vw;
    border-radius: 6vw;
    margin: 1vw;
    font-size: large;
    padding: 1vw;
}


.centered{
    width: 80%;
    margin: 0 auto;
}


.normal_button{
    border-radius: 6vw;
    border: solid 0.2vw black;
    color: black;
    background: yellow;
    padding: 0.5vw;
    margin-right: 1vw;
    margin-left: 1vw;
}

.normal_button:hover{
    transform: scale(1.1,1.1);
}


.normal_button:active{
    transform: scale(0.9,0.9);
}


.checkbox{
    width: 2vw;
    height: 2vw;
}</style>

</head>

<body>

    <header class="navbar">
        <span>🦜</span>
        <input id="button_take_lesson" type="button" value="Take Lesson" class="normal_button">
        <input id="button_craft_lesson" type="button" value="Craft Lesson" class="normal_button">
    </header>

    <div id="div_welcome" class="centered hidden" style="text-align: center;">
        <h1>Welcome to Psittacus!</h1>
        <p>To use this app offline, just save it as a .html.</p>
        <p>Windows/Linux: Ctrl + S</p>
        <p>Mac: ⌘ + S</p>
    </div>


    <div id="div_take_lesson" class="centered displayed">
        



    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Lesson</title>




    <label for="input_lesson_file" class="normal_button">
        Open Lesson From File
        <input type="file" id="input_lesson_file" hidden="">
    </label>

    <br>
    <br>

    <div id="take_lesson_div_root" class="hidden">

        <h2>Translate this sentence:</h2>

        <div id="div_problem"></div>
        <br>

        <input id="take_lesson_button_play_audio" type="button" value="Play Audio" class="normal_button">

        <input id="input_translation_answer" type="text" class="textbox">
        <br>

        <p>Your accuracy: <span id="p_grading"></span></p>

        <div id="div_solution" class="hidden"></div>

        <input id="take_lesson_button_next" type="button" value="See Solution" class="normal_button">

        <br>
        <br>

        <p><em>You can hover over words of the language you're learning to get quick hints.</em></p>


    </div>
    




    </div>

    <div id="div_craft_lesson" class="centered hidden">
        



    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craft Lesson</title>





    <label class="normal_button" title="Open an existing json file...">
        Edit Existing
        <input type="file" id="craft_lesson_input_existing_lesson" hidden="">
    </label>

    <p><em>You have the option to start from an existing lesson-file, edit it and save it as a new copy.</em></p>


    <br>
    <br>
    <br>
    <br>



    <input type="button" value="&lt;&lt;Previous Sentence" id="button_previous" class="normal_button" style="float: left;">
    <input type="button" value="Next Sentence&gt;&gt;" id="button_next" class="normal_button" style="float: right;">



    <br>

    <h3>Write a sentence in the target language:</h3>
    <input type="text" id="input_sentence_one" class="textbox">
    <br>
    <h3>Record yourself saying it:</h3>
    <input type="button" value="Record Audio🎙️" id="button_audio" class="normal_button">
    <input type="button" value="Play Audio ▶" id="button_play_audio" class="hidden   normal_button">

    <br>

    <h3>Translate to the source language:</h3>
    <p><em>(A language that your students undestand.)</em></p>
    <input type="text" id="input_sentence_two" class="textbox">
    <br>


    <br>
    <br>
    <h3>Give a brief definition of each word you used:</h3>
    <p><em>(The words will appear here as you type them above)</em></p>
    <table id="table_definitions"></table>

    <br>
    <br>

    <h3>Choose a Direction of Translation:</h3>

    <label for="invert_translation_direction">From target to source language (default)</label>
    <input type="checkbox" id="invert_translation_direction" class="checkbox" checked="checked">

    <br>

    <p><em>By default the student will be asked to translate from the language they're learning to their native language. You
            can change this behavior for any sentence, by unchecking the box.</em></p>

    <br>
    <br>

    <br>
    <br>

    <h3>This Lesson:</h3>


    <details id="input_metadata">
        <summary>Metadata</summary>
        <table>
            <tbody><tr>
                <td>Target Language</td>
                <td><input type="text" id="input_metadata_target_lang"></td>
            </tr>
            <tr>
                <td>Source Language</td>
                <td><input type="text" id="input_metadata_source_lang"></td>
            </tr>
            <tr>
                <td>Author</td>
                <td><input type="text" id="input_metadata_author"></td>
            </tr>
        </tbody></table>
    </details>



    <br>
    <br>

    <input type="button" value="Save to Computer" id="button_save_to_computer" class="normal_button">








    </div>


    <script defer="defer"> const recordAudio=()=>new Promise(async resolve=>{const stream=await navigator.mediaDevices.getUserMedia({audio:true});const mediaRecorder=new MediaRecorder(stream);const audioChunks=[];mediaRecorder.addEventListener("dataavailable",event=>{audioChunks.push(event.data);});const start=()=>mediaRecorder.start();const stop=()=>new Promise(resolve=>{mediaRecorder.addEventListener("stop",()=>{const audioBlob=new Blob(audioChunks,{type:"audio/mpeg"});const audioUrl=URL.createObjectURL(audioBlob);const audio=new Audio(audioUrl);const play=()=>audio.play();resolve({audioBlob,audioUrl,play});});mediaRecorder.stop();});resolve({start,stop});});async function audioToBase64(audioFile){return new Promise((resolve,reject)=>{let reader=new FileReader();reader.onerror=reject;reader.onload=(e)=>resolve(e.target.result);reader.readAsDataURL(audioFile);});}
class Recorder{constructor(){this.recording=null
this.recorder=null
this.base64=null}
record=async()=>{this.recorder=await recordAudio();this.recorder.start();}
stop=async()=>{this.recording=await this.recorder.stop();this.base64=await audioToBase64(this.recording.audioBlob);}
play=async()=>{this.recording.play();}}
function playBase64(base64String){let audio=document.createElement("audio")
audio.src=base64String
audio.play()}
class Proposition{constructor(jsonData){this.sentenceOne=jsonData.sentence_one
this.sentenceTwo=jsonData.sentence_two
this.audioBase64=jsonData.audio_base64
this.wordDict=jsonData.word_dict
this.targetToNative=jsonData.target_to_native??true}
play(){playBase64(this.audioBase64)}
check(users_translation){let correctSentence=this.targetToNative?this.sentenceTwo:this.sentenceOne
let counter=0;for(let userWord of users_translation.split(/\s+/)){if(correctSentence.split(/\s+/).includes(userWord)){counter++}}
return parseInt(100*counter/this.sentenceTwo.split(/\s+/).length)}}
class PropositionBuilder{constructor(){this.wordDict={}
this.recorder=new Recorder()
this.targetToNative=true;}
static fromExistingJson(jsonData){let pb=new PropositionBuilder()
pb.sentenceOne=jsonData.sentence_one
pb.sentenceTwo=jsonData.sentence_two
pb.wordDict=jsonData.word_dict
pb.recorder.base64=jsonData.audio_base64
pb.targetToNative=jsonData.target_to_native??true
return pb}
setSentenceOne(sentence_one){this.sentenceOne=sentence_one
return this}
setSentenceTwo(sentence_two){this.sentenceTwo=sentence_two
return this}
setDefinition(word,definition){this.wordDict[word]=definition
return this}
record(){this.recorder.record()
return this}
stopRecording(){this.recorder.stop()
return this}
isEmpty(){return!(this.sentenceOne&&this.sentenceTwo)}
playAudio(){playBase64(this.recorder.base64)}
invertTranslationDirection(){this.targetToNative=!this.targetToNative;}
toJson(){return{sentence_one:this.sentenceOne,sentence_two:this.sentenceTwo,word_dict:this.wordDict,audio_base64:this.recorder.base64,target_to_native:this.targetToNative}}}
class Lesson{constructor(jsonData){this.propositions=jsonData.propositions.map(p=>{return new Proposition(p)})
this.targetLanguage=jsonData.target_language??""
this.sourceLanguage=jsonData.source_language??""
this.author=jsonData.author??""
this.iterator=this.propositions.values()
this.next()}
next(){this.current=this.iterator.next().value}
getCurrent(){return this.current}}
function createElementFromHTML(htmlString){var div=document.createElement('span');div.innerHTML=htmlString.trim();return div}
function hideElement(element){element.classList.add("hidden");element.classList.remove("displayed");}
function showElement(element){element.classList.add("displayed");element.classList.remove("hidden");}
function saveToComp(content,fileName,contentType){var a=document.createElement("a");var file=new Blob([content],{type:contentType});a.href=URL.createObjectURL(file);a.download=fileName;a.click();}
class LessonBuilder{constructor(){this.propositions=[new PropositionBuilder()]
this.current=0}
static fromExistingJson(jsonData){let lb=new LessonBuilder()
lb.propositions=jsonData.propositions.map((p)=>{return PropositionBuilder.fromExistingJson(p)})
lb.targetLanguage=jsonData.target_language??""
lb.sourceLanguage=jsonData.source_language??""
lb.author=jsonData.author??""
return lb}
getCurrent(){return this.propositions[this.current]}
next(){if(!(this.propositions[this.current].sentenceOne&&this.propositions[this.current].sentenceTwo)){return}
this.current++
this.propositions[this.current]=this.propositions[this.current]??new PropositionBuilder()}
prev(){this.current=this.propositions[this.current-1]==undefined?this.current:this.current-1}
toJson(){return{target_language:this.targetLanguage??"",source_language:this.sourceLanguage??"",author:this.author??"",last_modified:new Date().getTime(),propositions:this.propositions.filter((p)=>!p.isEmpty()).map((p)=>p.toJson())}}}
document.getElementById("button_craft_lesson").addEventListener("click",function(){hideEverything()
showElement(document.getElementById("div_craft_lesson"))})
document.getElementById("button_take_lesson").addEventListener("click",function(){hideEverything()
showElement(document.getElementById("div_take_lesson"))})
function hideEverything(){hideElement(document.getElementById("div_take_lesson"))
hideElement(document.getElementById("div_craft_lesson"))
hideElement(document.getElementById("div_welcome"))}
document.getElementById("input_lesson_file").addEventListener("change",function(){let fr=new FileReader()
this.onclick=()=>{this.value=null}
fr.onload=function(){let lesson=new Lesson(JSON.parse(fr.result))
console.log(lesson)
startLesson(lesson)}
fr.readAsText(this.files[0])})
function startLesson(lesson){showElement(document.getElementById("take_lesson_div_root"))
window.lesson=lesson
displayProposition(lesson.getCurrent())}
function displayProposition(proposition){let inNativeLang=createElementFromHTML(`<p> ${proposition.sentenceTwo} </p>`)
let inTargetLang=document.createElement("div");for(let word of proposition.sentenceOne.split(/\s+/)){let wordSpan=createElementFromHTML(`<span class="word">${word}</span> <span class="tool_tip">${proposition.wordDict[word]??""} </span>`)
inTargetLang.appendChild(wordSpan)}
document.getElementById("div_problem").innerHTML=""
document.getElementById("div_solution").innerHTML=""
if(proposition.targetToNative){document.getElementById("div_problem").appendChild(inTargetLang)
document.getElementById("div_solution").appendChild(inNativeLang)
showElement(document.getElementById("take_lesson_button_play_audio"));proposition.play()}else{document.getElementById("div_problem").appendChild(inNativeLang)
document.getElementById("div_solution").appendChild(inTargetLang)
hideElement(document.getElementById("take_lesson_button_play_audio"));}}
document.getElementById("take_lesson_button_play_audio").addEventListener("click",function(){window.lesson.getCurrent().play()})
document.getElementById("take_lesson_button_next").addEventListener("click",new(function(){let seenSolution=false
return function(){if(seenSolution){hideElement(document.getElementById("div_solution"))
document.getElementById("input_translation_answer").value=""
document.getElementById("p_grading").innerHTML=""
window.lesson.next()
displayProposition(window.lesson.getCurrent())
document.getElementById("take_lesson_button_next").value="See Solution"}else{showElement(document.getElementById("div_solution"))
let grading=window.lesson.getCurrent().check(document.getElementById("input_translation_answer").value)
document.getElementById("p_grading").innerHTML=`${grading}%`
document.getElementById("take_lesson_button_next").value="Next"
if(!window.lesson.getCurrent().targetToNative){showElement(document.getElementById("take_lesson_button_play_audio"))
window.lesson.getCurrent().play()}}
seenSolution=!seenSolution}}))
window.lessonBuilder=new LessonBuilder()
displayPropositionCraftLesson(window.lessonBuilder.getCurrent())
document.getElementById("craft_lesson_input_existing_lesson").addEventListener("change",function(){let fr=new FileReader()
fr.onload=function(){window.lessonBuilder=LessonBuilder.fromExistingJson(JSON.parse(fr.result))
displayPropositionCraftLesson(window.lessonBuilder.getCurrent())
document.getElementById("button_play_audio").classList.add("displayed")
document.getElementById("input_metadata_target_lang").value=window.lessonBuilder.targetLanguage
document.getElementById("input_metadata_source_lang").value=window.lessonBuilder.sourceLanguage
document.getElementById("input_metadata_author").value=window.lessonBuilder.author}
fr.readAsText(this.files[0])})
document.getElementById("button_next").addEventListener("click",function(){move(true)
console.log(window.lessonBuilder)})
document.getElementById("button_previous").addEventListener("click",function(){move(false)})
document.getElementById("button_audio").addEventListener("click",new(function(){let recording=false
return function(){if(recording){window.lessonBuilder.getCurrent().stopRecording()
recording=false;document.getElementById("button_audio").value="Record Audio🎙️"
document.getElementById("button_play_audio").classList.add("displayed")}else{window.lessonBuilder.getCurrent().record();recording=true;document.getElementById("button_audio").value="Stop Recording 🔴"}}}))
document.getElementById("input_sentence_one").addEventListener("input",function(){window.lessonBuilder.getCurrent().wordDict=defintionTableToDict()
clearDefintionsTable()
for(let word of document.getElementById("input_sentence_one").value.split(/\s+/)){newRowInDefinitionsTable(word,window.lessonBuilder.getCurrent().wordDict[word]??"")}})
document.getElementById("button_play_audio").addEventListener("click",function(){window.lessonBuilder.getCurrent().playAudio()})
document.getElementById("button_save_to_computer").addEventListener("click",function(){saveCurrentProposition()
console.log(window.lessonBuilder.toJson())
saveToComp(JSON.stringify(window.lessonBuilder.toJson()),"lesson","text/plain")})
document.getElementById("invert_translation_direction").addEventListener("change",function(){window.lessonBuilder.getCurrent().invertTranslationDirection();})
document.getElementById("input_metadata_target_lang").addEventListener("input",function(){window.lessonBuilder.targetLanguage=document.getElementById("input_metadata_target_lang").value})
document.getElementById("input_metadata_source_lang").addEventListener("input",function(){window.lessonBuilder.sourceLanguage=document.getElementById("input_metadata_source_lang").value})
document.getElementById("input_metadata_author").addEventListener("input",function(){window.lessonBuilder.author=document.getElementById("input_metadata_author").value})
function saveCurrentProposition(){let sentenceOne=document.getElementById("input_sentence_one").value
let sentenceTwo=document.getElementById("input_sentence_two").value
window.lessonBuilder.getCurrent().setSentenceOne(sentenceOne).setSentenceTwo(sentenceTwo)
window.lessonBuilder.getCurrent().wordDict=defintionTableToDict()}
function displayPropositionCraftLesson(proposition){document.getElementById("input_sentence_one").value=proposition.sentenceOne??""
document.getElementById("input_sentence_two").value=proposition.sentenceTwo??""
dictToDefinitionTable(proposition.wordDict)
document.getElementById("invert_translation_direction").checked=proposition.targetToNative}
function move(forward){saveCurrentProposition()
forward?window.lessonBuilder.next():window.lessonBuilder.prev()
displayPropositionCraftLesson(window.lessonBuilder.getCurrent())}
function newRowInDefinitionsTable(word,translation){var row=document.getElementById("table_definitions").insertRow();var cell1=row.insertCell(0);var cell2=row.insertCell(1);word=word.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');translation=translation.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');cell1.innerHTML=`<input  type='text' value="${word}">`;cell2.innerHTML=`<input  type='text' value="${translation}">`;}
function clearDefintionsTable(){document.getElementById("table_definitions").innerHTML=""}
function defintionTableToDict(){var d={}
for(let row of document.getElementById("table_definitions").rows){try{let word=row.cells[0].children[0].value
let definition=row.cells[1].children[0].value
d[word]=definition}catch{}}
return d}
function dictToDefinitionTable(dict){clearDefintionsTable()
for(let entry of Object.entries(dict)){newRowInDefinitionsTable(entry[0],entry[1])}} </script>


    <footer class="footer">
        <p>Aiman Al Masoud © <a href="https://github.com/aiman-al-masoud/psittacus" title="link to the code" target="_blank">Psittacus</a> is free software, distributed under <a href="https://www.gnu.org/licenses/gpl-3.0.html" title="link to the license" target="_blank">GNU GPLv3</a>.</p>
    </footer>



</body></html>
